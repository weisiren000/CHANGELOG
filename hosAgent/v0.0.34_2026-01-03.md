# hosAgent v0.0.34 (2026-01-03)

## 变更概览

- **响应处理重构**：将臃肿的 `responseHandlers.ts` 拆分为模块化的 `handlers`、`sse` 和 `utils` 目录，提升代码可维护性。
- **工具调用增强**：`executor.ts` 全面升级，支持多轮工具调用循环 (Loop)，并完美兼容 DeepSeek 思考模式 (Reasoning) 下的工具调用。
- **流式响应优化**：重写 SSE 写入逻辑，支持更复杂的事件流（包括 `tool_call_start`, `tool_call_result`, `reasoning` 等）。

## 详情

### Refactor

- **响应处理模块拆分** (`backend/src/routes/sessions/services/responseHandlers/`)
  - **Handlers**: 拆分为 `StreamHandler` (流式)、`NonStreamHandler` (非流式)、`EmergencyHandler` (紧急熔断)。
  - **SSE**: 独立 `SSEWriter` 和 `PartTracker` 类，统一管理 Server-Sent Events 格式与分块追踪。
  - **Utils**: 提取 `toolCallUtils` (工具调用构建) 和 `messageUtils` (消息格式化)。
- **Chat 接口优化** (`backend/src/routes/sessions/handlers/chat.ts`)
  - 简化主流程逻辑，将具体响应构建委托给新的 Handler 模块。
  - 统一了配置解析、安全检查、多模态检查的预处理步骤。

### Added

- **高级工具执行器** (`backend/src/core/provider/tools/executor.ts`)
  - 新增 `handleToolCallLoop`：支持非流式模式下的自动多轮工具调用（最多 3 轮）。
  - 新增 `handleToolCallLoopStream`：支持流式模式下的自动多轮工具调用，实时输出 `reasoning` 和 `tool_call` 事件。
  - 支持 **DeepSeek 思考模型**：在工具调用过程中正确捕获并回传 `reasoning_content`，防止思考链断裂。
  - 新增 `ToolCallStreamEvent` 类型定义，规范化流式事件输出。

### Changed

- **工具调用流程**
  - 工具调用不再是单次执行，而是自动进入循环，直到模型输出最终结果或达到最大轮数。
  - 优化了 `buildMessagesWithToolResults`，严格遵循 OpenAI 消息格式规范 (User -> Assistant[ToolCalls] -> Tool[Results])。
- **SSE 数据格式**
  - 流式响应中增加了对 `tool_call_start` (工具开始调用) 和 `tool_call_result` (工具执行结果) 事件的支持，前端可据此渲染更丰富的 UI。

## 备注

- 本次重构大幅降低了 `chat.ts` 的复杂度，为未来扩展更多响应类型（如二进制流、WebSocket）打下基础。
- 增强的 `executor` 让 Agent 能够连续执行多个相关联的操作（如：查询天气 -> 根据天气推荐穿搭 -> 查询穿搭购买链接）。

## Technical Details

- Commit: `d92c4bf` - refactor(backend): 重构响应处理与增强工具调用支持 (2026-01-03)