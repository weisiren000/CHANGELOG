# hosAgent v0.0.28（2025-12-29）

## 变更概览

- **错误重试增强**：实现 429 Rate Limit 和 5xx 服务器错误的自动重试机制
- **语音输入优化**：根据模型能力自动选择音频录制或语音识别模式
- **配置管理重构**：简化配置加载流程，实现配置自动应用到主界面
- **ASR 服务增强**：优化 API Key 获取逻辑，支持自动查找配置

## 详情

### Changed

- **BaseProvider**: 流式请求集成 `fetchWithRetry`，支持 429/5xx 错误自动重试，最大重试 3 次
- **fetchWithRetry**: 增强错误重试机制
  - 新增 429（Rate Limit）错误重���支持
  - 支持 `Retry-After` 响应头的等待时间
  - 实现指数退避策略（默认 1s, 2s, 4s...）
  - 添加详细的日志记录

- **ASR 路由**（`backend/src/routes/asr.ts`）:
  - 优化 API Key 获取优先级：直接传入 > configId > 自动查找
  - 支持当传入的 configId 不是 SiliconFlow 时，自动查找 SiliconFlow 配置
  - 移除未使用的 language 参数（预留给未来多语言支持）

- **useChat**: 重构语音输入策略
  - 根据模型是否支持音频，自动选择音频录制或语音识别模式
  - 模型支持音频 → 使用 `useAudioRecorder` 直接发送音频
  - 模型不支持音频 → 使用 Web Speech API 语音识别转文字
  - 添加详细的模式切换日志

- **useAudioRecorder**: 启动失败时重新抛出异常，让调用者感知

### Fixed

- **AIConfig 组件**: 修复模型列表加载时的 useEffect 依赖问题，避免不必要的重复加载
- **Console 配置管理**: 修复配置加载后未自动应用到主界面的问题
  - 加载配置时自动调用 `setGlobalConfigId`
  - 保存配置时自动应用到主界面
- **useMediaUpload**: 修复当前模型信息获取逻辑，添加模型列表和配置的自动加载

### Technical

- **Chat Store**: 添加 hydration 后自动加载
  - 应用启动后自动获取模型列表
  - 如果存在 configId，自动加载配置详情
- **modelActions**: 增强 `fetchConfig` 和 `getCurrentModel` 的日志记录
- **apiHelpers**: 新增 `transcribeAudio` 工具函数，封装 ASR 服务调用

## 备注

本次更新主要提升了系统的稳定性和用户体验：
- **稳定性**：429 错误重试机制可有效应对 API Rate Limit，避免请求失败
- **用户体验**：语音输入策略根据模型能力自动适配，无需用户手动选择
- **开发体验**：配置管理自动化，减少手动应用配置的操作步骤

## Technical Details

- Commit: `1b144f7` - feat(retry): 实现 429 错误重试并优化语音输入策略 (2025-12-29 08:28)