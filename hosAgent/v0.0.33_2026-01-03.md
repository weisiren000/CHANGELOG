# hosAgent v0.0.33 (2026-01-03)

## 变更概览

- AI Function Calling：实现完整的工具调用系统，支持 AI 自动调用预定义工具
- 数据库扩展：新增 tool_calls、tool_call_id 字段，支持工具调用历史记录
- Provider 重构：新增 chat() 方法，返回包含工具调用的完整结果
- 前端优化：样式模块化拆分，新增工具调用气泡组件
- 类型增强：完善工具调用相关类型定义

## 详情

### Added

- **工具模块** (backend/src/core/provider/tools/)
  - 工具定义(ToolDefinition)、工具调用(ToolCall)类型系统
  - 工具注册表(ToolRegistry)：管理工具注册和执行
  - 工具执行器(ToolExecutor)：自动处理工具调用循环(最多 5 轮)
  - 预设工具：获取当前时间(get_current_time)、获取天气(get_weather)
  - 流式工具调用事件处理(handleToolCallLoopStream)

- **数据库扩展**
  - messages 表新增 tool_calls 字段(JSON)：存储 AI 请求的工具调用
  - messages 表新增 tool_call_id 字段：工具结果消息关联调用 ID
  - messages 表 role 约束支持 'tool' 角色
  - ai_configs 表新增 enable_tools 字段：启用/禁用工具调用

- **Provider 增强**
  - BaseProvider 新增 buildToolsParams() 方法：构建工具请求参数
  - BaseProvider 支持工具调用消息转换(historyToMessages)
  - 各 Provider(DeepSeek、OpenRouter、SiliconFlow、Zhipu)实现 chat() 方法
  - chat() 方法返回 ChatResult：包含 content、reasoning、toolCalls

- **前端组件**
  - ToolCallBubble 组件：显示工具调用名称和参数
  - ChatArea 组件支持渲染工具调用消息(role="tool" 和 tool_calls)
  - streamHandler 处理工具调用流式事件(tool_call 类型)

- **样式模块化** (frontend/src/app/styles/)
  - tokens.css：CSS 变量 / 设计 Token
  - base.css：基础样式 + Kiosk 优化
  - animations/：动画样式(mic-button、marquee、think)
  - markdown/：Markdown 渲染样式(streamdown、chat、think)

### Changed

- Provider 服务新增 chat() 函数：完整问答，支持工具调用
- ChatOptions 新增 tools 和 toolChoice 参数
- ChatMessage / HistoryMessage 支持工具调用消息类型
- StreamChunk 新增 tool_call 类型：工具调用块
- globals.css 简化：仅保留 @import 语句，样式拆分到各模块

### Technical

- 工具调用遵循 OpenAI Function Calling 规范
- 工具调用循环支持流式和非流式模式
- 最大工具调用轮数限制：5 轮(防止死循环)
- 工具执行错误处理：失败时返回错误消息给 AI
- 数据库迁移自动更新 schema(ALTER TABLE + 表重建)

## 备注

- 工具调用默认关闭，需在 AI 配置中启用 enableTools
- 工具调用消息会保存到数据库，支持历史记录查看
- 前端样式拆分后更易维护，遵循单一职责原则
- 完整的单元测试覆盖(types、registry、executor、integration)

## Technical Details

- Commit: `609f355` - feat(ai-function-calling): 实现 AI Function Calling 工具调用系统 (2026-01-03 03:12)