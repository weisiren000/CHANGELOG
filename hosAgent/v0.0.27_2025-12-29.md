# hosAgent v0.0.27（2025-12-29）

## 变更概览

- 视频智能采样：新增按供应商智能采样策略模块，优化视频理解性能
- Provider 重构：更新 SiliconFlow 和 Zhipu Provider 使用智能视频采样
- 架构优化：移除旧的路由文件，采用模块化 sessions/index 结构
- 数据更新：更新模型定价信息和上下文长度（DeepSeek、GLM-4.6V、Qwen3-Omni）

## 详情

### Added

- 新增 `backend/src/core/provider/multimodal/video/` 智能采样策略模块
  - `SamplingStrategyFactory.ts` - 策略工厂类，按供应商选择采样策略
  - `types.ts` - 视频元数据类型定义（`VideoMetadata`、`SamplingParams`）
  - `strategies/` - 供应商特定采样策略实现
    - `BaseSamplingStrategy.ts` - 基类接口定义
    - `SiliconFlowStrategy.ts` - SiliconFlow 采样策略（fps=1, maxFrames=16）
    - `ZhipuStrategy.ts` - 智谱采样策略（直接透传视频）
    - `OpenRouterStrategy.ts` - OpenRouter 采样策略（直接透传视频）
    - `DefaultStrategy.ts` - 默认采样策略
- 新增 `videoMetadata` 参数支持，用于智能计算视频采样参数
- 新增调试日志支持多模态内容追踪

### Changed

- **VideoHandler 重构** (`backend/src/core/provider/multimodal/VideoHandler.ts`)
  - 支持按供应商智能采样（通过 `provider` 参数）
  - 支持视频元数据驱动的动态参数计算
  - 新增静态方法 `needsSampling()` 和 `getSamplingParams()`
- **SiliconFlowProvider 更新** (`backend/src/core/provider/providers/SiliconFlowProvider.ts`)
  - 使用 `VideoHandler.buildVideoPart()` 替代手动构建视频内容
  - 传入 `provider: 'siliconflow'` 触发智能采样
- **ZhipuProvider 更新** (`backend/src/core/provider/providers/ZhipuProvider.ts`)
  - 使用 `VideoHandler.buildVideoPart()` 替代手动构建视频内容
  - 传入 `provider: 'zhipu'` 触发智能采样
  - 增强 `file_url` 处理：检查并警告 base64 格式（智谱 API 仅支持 HTTPS URL）
  - 添加调试日志输出原始 delta
- **Provider Service 更新** (`backend/src/core/provider/service.ts`)
  - 新增 `videoMetadata` 参数传递到各 Provider
  - 添加 Zhipu 多模态调试日志
- **路由模块化** (`backend/src/routes/sessions/`)
  - 移除旧的单文件 `sessions.ts`（521 行）
  - 新增模块化结构：
    - `index.ts` - 路由入口
    - `handlers/` - 请求处理器（chat.ts、crud.ts、messages.ts）
    - `services/` - 业务逻辑（chatService.ts、responseHandlers.ts）
    - `schemas.ts` - Zod 验证 Schema
- **模型定义更新**
  - `deepseek/chat.ts` - 定价更新为美元计价
  - `deepseek/reasoner.ts` - 定价更新为美元计价
  - `siliconflow/glm-4.6v.ts` - 上下文长度更新为 131K，定价更新
  - `siliconflow/qwen3-omni.ts` - 上下文长度更新为 66K
- **类型定义更新**
  - `backend/src/core/provider/base/types.ts` - 新增 `videoMetadata` 字段
  - `backend/src/core/provider/types.ts` - 导出并复用 `VideoMetadata` 类型

### Removed

- 删除 `backend/src/routes/sessions.ts`（521 行），迁移至模块化结构

### Technical

- `.gitignore` 更新：`__logs__` → `logs/`
- 添加智能视频采样策略模式（Strategy Pattern）
- 供应商特定采样参数：
  - **SiliconFlow**：fps=1, maxFrames=16, detail='high'
  - **Zhipu**：直接透传视频 URL（无采样参数）
  - **OpenRouter**：直接透传视频 URL（无采样参数）

## 备注

- 智能采样策略模块支持按供应商动态选择最优视频处理方式
- 视频元数据可包含时长、分辨率等信息，用于智能计算采样参数
- Zhipu 的 `file_url` 仅支持 HTTPS URL，不支持 base64 格式，代码中已添加检测和警告
- 路由模块化提升了代码可维护性和可测试性

## Technical Details

- Commit: `a9d7f2a` - feat(video): 实现视频智能采样策略并优化 Provider 架构 (2025-12-29 14:45)